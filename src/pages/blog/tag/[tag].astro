---
import { getCollection, type CollectionEntry } from 'astro:content';
import BlogCard from '@components/blog/BlogCard.astro';
import BaseLayout from '@layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => (import.meta.env.PROD ? !data.draft : true));
  const tags = [...new Set(posts.flatMap((post) => post.data.tags))].sort((a, b) => a.localeCompare(b, 'ja'));

  return tags.map((tag) => ({
    params: { tag },
    props: {
      tag,
      posts: posts
        .filter((post) => post.data.tags.includes(tag))
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
    },
  }));
}

interface Props {
  tag: string;
  posts: CollectionEntry<'blog'>[];
}

const { tag, posts } = Astro.props as Props;
---

<BaseLayout title={`タグ: ${tag} | Signal & Sprocket`} description={`#${tag} が付いた記事一覧です。`}>
  <section class="mb-8">
    <h1 class="text-4xl">タグ: #{tag}</h1>
    <p class="mt-3 text-sm opacity-80">{posts.length} 件の記事があります。</p>
  </section>

  <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
    {posts.map((post) => <BlogCard post={post} />)}
  </div>
</BaseLayout>
