<dialog id="site-search-dialog" class="site-search-dialog" aria-label="サイト内検索">
  <div class="search-modal-panel card-surface" role="document">
    <div class="search-modal-head">
      <h2 class="text-base font-bold tracking-wide">Search</h2>
      <button type="button" class="search-modal-close" data-search-modal-close aria-label="検索モーダルを閉じる">
        閉じる
      </button>
    </div>
    <div id="site-search-host" class="min-h-[40px]" data-search-status="loading"></div>
    <p id="site-search-fallback" class="mt-3 hidden text-sm text-rose-500" role="status">
      検索を読み込めませんでした。時間をおいて再度お試しください。
    </p>
  </div>
</dialog>

<link href="/pagefind/pagefind-ui.css" rel="stylesheet" />
<script src="/pagefind/pagefind-ui.js" is:inline data-astro-rerun></script>
<script is:inline data-astro-rerun>
  (() => {
    const SEARCH_OPEN_EVENT = 'site-search:open';
    const SEARCH_DIALOG_SELECTOR = '#site-search-dialog';
    const SEARCH_HOST_SELECTOR = '#site-search-host';
    const SEARCH_FALLBACK_SELECTOR = '#site-search-fallback';
    const SEARCH_CLOSE_SELECTOR = '[data-search-modal-close]';

    const SEARCH_OPEN_HANDLER_KEY = '__siteSearchModalOpenHandler';
    const SEARCH_CLOSE_HANDLER_KEY = '__siteSearchModalCloseHandler';
    const SEARCH_CLICK_HANDLER_KEY = '__siteSearchModalClickHandler';
    const SEARCH_CANCEL_HANDLER_KEY = '__siteSearchModalCancelHandler';
    const SEARCH_CLOSE_EVENT_HANDLER_KEY = '__siteSearchModalCloseEventHandler';
    const SEARCH_AFTER_SWAP_HANDLER_KEY = '__siteSearchModalAfterSwapHandler';
    const SEARCH_INIT_RETRY_TIMER_KEY = '__siteSearchModalRetryTimer';

    function clearRetryTimer() {
      const timer = window[SEARCH_INIT_RETRY_TIMER_KEY];
      if (typeof timer === 'number') {
        window.clearTimeout(timer);
      }
      window[SEARCH_INIT_RETRY_TIMER_KEY] = null;
    }

    function showSearchError(host, fallback, reason) {
      host.setAttribute('data-search-status', 'error');
      host.removeAttribute('data-bound');
      fallback?.classList.remove('hidden');
      console.warn('[search-modal] Pagefind initialization failed:', reason);
    }

    function focusSearchInput() {
      const input = document.querySelector('#site-search-host .pagefind-ui__search-input');
      if (!(input instanceof HTMLInputElement)) return false;

      try {
        input.focus({ preventScroll: true });
      } catch {
        input.focus();
      }
      input.select?.();
      return true;
    }

    function focusSearchInputWhenReady(attempt = 0) {
      if (focusSearchInput()) return;
      if (attempt >= 24) return;
      window.requestAnimationFrame(() => focusSearchInputWhenReady(attempt + 1));
    }

    function getDialog() {
      const dialog = document.querySelector(SEARCH_DIALOG_SELECTOR);
      if (dialog instanceof HTMLDialogElement) return dialog;
      return null;
    }

    function setModalOpenState(isOpen) {
      document.documentElement.classList.toggle('search-modal-open', isOpen);
    }

    function closeSearchModal() {
      const dialog = getDialog();
      if (!dialog) return;
      if (dialog.open) dialog.close();
      setModalOpenState(false);
    }

    function mountPagefind(attempt = 0) {
      const host = document.querySelector(SEARCH_HOST_SELECTOR);
      const fallback = document.querySelector(SEARCH_FALLBACK_SELECTOR);
      if (!host) {
        clearRetryTimer();
        return;
      }

      if (host.getAttribute('data-bound') === '1') return;

      if (!window.PagefindUI) {
        if (attempt < 20) {
          clearRetryTimer();
          window[SEARCH_INIT_RETRY_TIMER_KEY] = window.setTimeout(() => mountPagefind(attempt + 1), 80);
          return;
        }
        showSearchError(host, fallback, 'window.PagefindUI is unavailable');
        return;
      }

      fallback?.classList.add('hidden');
      host.setAttribute('data-search-status', 'loading');

      try {
        new window.PagefindUI({
          element: '#site-search-host',
          showSubResults: true,
          showImages: false,
          translations: {
            placeholder: '記事を検索...',
          },
        });
        host.setAttribute('data-bound', '1');
        host.setAttribute('data-search-status', 'ready');
        clearRetryTimer();
      } catch (error) {
        clearRetryTimer();
        showSearchError(host, fallback, error);
      }
    }

    function openSearchModal() {
      const dialog = getDialog();
      if (!dialog) return;

      mountPagefind();
      if (!dialog.open) dialog.showModal();
      setModalOpenState(true);
      focusSearchInputWhenReady();
    }

    function bindOpenListener() {
      if (typeof window[SEARCH_OPEN_HANDLER_KEY] === 'function') {
        window.removeEventListener(SEARCH_OPEN_EVENT, window[SEARCH_OPEN_HANDLER_KEY]);
      }

      const onSearchOpenRequested = () => openSearchModal();
      window[SEARCH_OPEN_HANDLER_KEY] = onSearchOpenRequested;
      window.addEventListener(SEARCH_OPEN_EVENT, onSearchOpenRequested);
    }

    function bindDialogInteractions() {
      const dialog = getDialog();
      const closeButton = dialog?.querySelector(SEARCH_CLOSE_SELECTOR);
      if (!dialog || !(closeButton instanceof HTMLButtonElement)) return;

      if (typeof window[SEARCH_CLOSE_HANDLER_KEY] === 'function') {
        closeButton.removeEventListener('click', window[SEARCH_CLOSE_HANDLER_KEY]);
      }
      if (typeof window[SEARCH_CLICK_HANDLER_KEY] === 'function') {
        dialog.removeEventListener('click', window[SEARCH_CLICK_HANDLER_KEY]);
      }
      if (typeof window[SEARCH_CANCEL_HANDLER_KEY] === 'function') {
        dialog.removeEventListener('cancel', window[SEARCH_CANCEL_HANDLER_KEY]);
      }
      if (typeof window[SEARCH_CLOSE_EVENT_HANDLER_KEY] === 'function') {
        dialog.removeEventListener('close', window[SEARCH_CLOSE_EVENT_HANDLER_KEY]);
      }

      const onCloseClick = () => closeSearchModal();
      const onDialogClick = (event) => {
        if (event.target === dialog) closeSearchModal();
      };
      const onDialogCancel = () => setModalOpenState(false);
      const onDialogClose = () => setModalOpenState(false);

      window[SEARCH_CLOSE_HANDLER_KEY] = onCloseClick;
      window[SEARCH_CLICK_HANDLER_KEY] = onDialogClick;
      window[SEARCH_CANCEL_HANDLER_KEY] = onDialogCancel;
      window[SEARCH_CLOSE_EVENT_HANDLER_KEY] = onDialogClose;

      closeButton.addEventListener('click', onCloseClick);
      dialog.addEventListener('click', onDialogClick);
      dialog.addEventListener('cancel', onDialogCancel);
      dialog.addEventListener('close', onDialogClose);
    }

    function bindAfterSwap() {
      if (typeof window[SEARCH_AFTER_SWAP_HANDLER_KEY] === 'function') {
        document.removeEventListener('astro:after-swap', window[SEARCH_AFTER_SWAP_HANDLER_KEY]);
      }

      const onAfterSwap = () => {
        bindDialogInteractions();
      };
      window[SEARCH_AFTER_SWAP_HANDLER_KEY] = onAfterSwap;
      document.addEventListener('astro:after-swap', onAfterSwap);
    }

    bindOpenListener();
    bindDialogInteractions();
    bindAfterSwap();
  })();
</script>
