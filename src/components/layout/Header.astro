---
import ThemeToggle from './ThemeToggle.astro';

const navItems = [
  { href: '/blog/', label: 'Blog' },
  { href: '/about/', label: 'About' },
  { href: '/blog/page/1/', label: 'Archive' },
];

const utilityLinks = [
  { href: '/rss.xml', label: 'RSS', ariaLabel: 'RSS Feed', icon: 'rss' },
  { href: 'https://github.com/your-username', label: 'GitHub', ariaLabel: 'GitHub', icon: 'github', external: true },
];

const activePath = Astro.url.pathname;
---

<header id="site-header" class="glass-header">
  <div class="content-container">
    <div class="header-pill">
      <a href="/" class="site-mark">
        Signal & Sprocket
      </a>

      <nav class="hidden md:block" aria-label="Primary">
        <ul class="flex items-center gap-2">
          {navItems.map((item) => (
            <li>
              <a class="floating-nav-link" href={item.href} aria-current={activePath === item.href ? 'page' : undefined}>{item.label}</a>
            </li>
          ))}
        </ul>
      </nav>

      <div class="header-tools">
        <button
          type="button"
          class="floating-search hidden lg:flex"
          aria-label="検索モーダルを開く"
          data-search-trigger="site-search-open"
        >
          <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" aria-hidden="true">
            <path d="M13.5 13.5L18 18M15.5 8.5a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
          </svg>
          <span>検索</span>
          <kbd class="shortcut-hint">⌘ K</kbd>
        </button>

        <ThemeToggle />

        {utilityLinks.map((item) => (
          <a
            class="floating-icon-btn hidden sm:inline-flex"
            href={item.href}
            aria-label={item.ariaLabel}
            title={item.label}
            target={item.external ? '_blank' : undefined}
            rel={item.external ? 'noopener noreferrer' : undefined}
          >
            {
              item.icon === 'rss' ? (
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M5 17a2 2 0 100 4 2 2 0 000-4zM4 11a9 9 0 019 9M4 5a15 15 0 0115 15" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" />
                </svg>
              ) : (
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M9 19c-4.5 1.4-4.5-2.2-6.3-2.8m12.6 5.6v-3.6a3.1 3.1 0 00-.9-2.4c3-.3 6.1-1.5 6.1-6.7a5.2 5.2 0 00-1.4-3.6 4.8 4.8 0 00-.1-3.6s-1.1-.3-3.8 1.4a13.2 13.2 0 00-7 0C5.5 2 4.4 2.3 4.4 2.3a4.8 4.8 0 00-.1 3.6 5.2 5.2 0 00-1.4 3.6c0 5.2 3.1 6.4 6.1 6.7a2.8 2.8 0 00-.8 2.1v3.9" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              )
            }
          </a>
        ))}
      </div>
    </div>
  </div>
</header>

<script is:inline>
  const HANDLER_KEY = '__siteHeaderScrollHandler';
  const SEARCH_TRIGGER_KEY = '__siteHeaderSearchTriggerHandler';
  const SEARCH_SHORTCUT_KEY = '__siteHeaderSearchShortcutHandler';
  const SEARCH_TRIGGER_SELECTOR = '[data-search-trigger="site-search-open"]';
  const SEARCH_OPEN_EVENT = 'site-search:open';

  function mountScrollAwareHeader() {
    const header = document.getElementById('site-header');
    if (!header) return;

    if (typeof window[HANDLER_KEY] === 'function') {
      window.removeEventListener('scroll', window[HANDLER_KEY]);
    }

    let lastY = window.scrollY;
    let ticking = false;

    const setVisible = (visible) => {
      header.classList.toggle('header-hidden', !visible);
    };

    const syncState = () => {
      const currentY = window.scrollY;
      const delta = currentY - lastY;

      if (currentY <= 72) {
        setVisible(true);
      } else if (delta > 8) {
        setVisible(false);
      } else if (delta < -8) {
        setVisible(true);
      }

      lastY = currentY;
      ticking = false;
    };

    const onScroll = () => {
      if (ticking) return;
      ticking = true;
      window.requestAnimationFrame(syncState);
    };

    window[HANDLER_KEY] = onScroll;
    window.addEventListener('scroll', onScroll, { passive: true });
    syncState();
  }

  function requestSiteSearchOpen() {
    window.dispatchEvent(new CustomEvent(SEARCH_OPEN_EVENT));
  }

  function mountHeaderSearchTrigger() {
    const trigger = document.querySelector(SEARCH_TRIGGER_SELECTOR);
    if (!trigger) return;

    if (typeof window[SEARCH_TRIGGER_KEY] === 'function') {
      trigger.removeEventListener('click', window[SEARCH_TRIGGER_KEY]);
    }

    const onSearchTriggerClick = () => {
      requestSiteSearchOpen();
    };

    window[SEARCH_TRIGGER_KEY] = onSearchTriggerClick;
    trigger.addEventListener('click', onSearchTriggerClick);
  }

  function mountSearchShortcut() {
    if (typeof window[SEARCH_SHORTCUT_KEY] === 'function') {
      window.removeEventListener('keydown', window[SEARCH_SHORTCUT_KEY]);
    }

    const onSearchShortcut = (event) => {
      const target = event.target;
      if (
        target instanceof HTMLInputElement ||
        target instanceof HTMLTextAreaElement ||
        (target instanceof HTMLElement && target.isContentEditable)
      ) {
        return;
      }
      if (!(event.metaKey || event.ctrlKey) || event.key.toLowerCase() !== 'k') return;
      event.preventDefault();
      requestSiteSearchOpen();
    };

    window[SEARCH_SHORTCUT_KEY] = onSearchShortcut;
    window.addEventListener('keydown', onSearchShortcut);
  }

  mountScrollAwareHeader();
  mountHeaderSearchTrigger();
  mountSearchShortcut();
  document.addEventListener('astro:after-swap', mountScrollAwareHeader);
  document.addEventListener('astro:after-swap', mountHeaderSearchTrigger);
  document.addEventListener('astro:after-swap', mountSearchShortcut);
</script>
